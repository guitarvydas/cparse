<!DOCTYPE html>
<html>
<head>
<style>
textarea {
}
</style>
</head>
<body>

<h1>Example PRINTF Inserter</h1>

<p>source:</p>
<textarea id="src" rows="5" cols="90" placeholder="markdown" style="background-color:oldlace;">
  x;{y;{z;}}
</textarea>

<p>modified:</p>
<textarea id="output" rows="7" cols="90" placeholder="transpiled"  readonly style="background-color:whitesmoke;">
</textarea>
<br>
<br>
<p id="status" > READY </p>

<!-- Ohm-JS -->
<script src="https://unpkg.com/ohm-js@16/dist/ohm.min.js"></script>


<br>
<button onclick="insert ()">Insert Printfs</button>
<script>

const grammar = ohm.grammar(String.raw`
balanced {
  main = matched
  matched =
    | matched? "{" matched "}" matched? -- braces
    | anythingelse+                     -- bottom
  anythingelse = ~"{" ~"}" any
}
`);

  const dontcare = -1;  // it doesn't matter what this value is
  
  const rewriteRules = {
      main: function (matched) { return matched.walk (this.args.blockNumber); },
      matched_braces: function (_block_pre, _lb, _block_in, _rb, _block_post) {
          // "lb" means "left brace", "rb" means "right brace"
          var blockNumber = this.args.blockNumber;
          var next = blockNumber + 1;
          var block_pre = _block_pre.walk (next);
          var lb = _lb.walk (next);
          var block_in = _block_in.walk (next);
          var rb = _rb.walk (next);
          var block_post = _block_post.walk (next);
          return `${block_pre}${lb}\nprintf(">> in block ${blockNumber}");\n${block_in}\nprintf("<< out block ${blockNumber}");\n${rb}${block_post}`;
      },
      matched_bottom: function (anythingelse) {
          return anythingelse;
          // return anythingelse.walk (dontcare).join ('');
      },
      anythingelse: function (c) { return c.walk (dontcare); },
      
      // required by Ohm-JS...
      _terminal: function () { return this.sourceString; },
      _iter: function (...children) { return children.map(c => c.walk (this.args.blockNumber)); }
  };

  function insert () {
      let src = document.getElementById('src').value;
      let matchResult = grammar.match (src);
      if (matchResult.succeeded ()) {
          document.getElementById('status').innerHTML = "OK";
          let sem = grammar.createSemantics ();
          sem.addOperation ('walk (blockNumber)', rewriteRules);
          let treeWalker = sem (matchResult);
          let text = treeWalker.walk (1);
          var s = text.toString ();
          document.getElementById('output').value = s;
      } else {
          document.getElementById('status').innerHTML = "parse FAILED";
      }
  }
  </script>
</body>
</html>

